<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&icon_names=add_comment,arrow_back,delete" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
</head>
<style>
    .material-symbols-outlined {
        font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
    }
</style>

<body>
    <div class="chat-layout">
        <aside class="history-sidebar">
            <div class="sidebar-header">
                <h2>History Conversations</h2>
                <button id="sidebar-new-chat-btn" onclick="newChat()" title="New Chat">
                    <span class="material-symbols-outlined">add_comment</span>
                </button>
                <button id="clear-history-btn" onclick="deleteChatHistory()" title="Clear History">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
            <div class="chat-list">
                {% for chat in chats %}
                <div class="chat-item {% if chat.chat_id == request.args.get('chat_id') %}active{% endif %}"
                    onclick="loadChat('{{ chat.chat_id }}')">
                    <div class="chat-preview">{{ chat.chat_title }}</div>
                    <small class="chat-time">{{ chat.created_at.strftime('%Y-%m-%d %H:%M') if chat.created_at else 'Just
                        now' }}</small>
                </div>
                {% endfor %}
                {% if not chats %}
                <div class="empty-history">No history</div>
                {% endif %}
            </div>
        </aside>

        <div class="main-content">
            <header>
                <div class="header-content">
                    <button id="back-button" onclick="window.location.href='{{ url_for('features') }}'"
                        title="Back to Features">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <h1 id="chat-header-title">
                        AI Chatbot: Your Financial Assistant
                    </h1>
                </div>
            </header>

            <main>
                <section id="chatbot-window">
                    <div id="chatbox" class="{% if not history %}empty{% endif %}">
                        {% if history %}
                        {% for msg in history %}
                        <div class="message {{ msg.role }}-message">
                            <div class="message-content">{{ msg.content }}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div id="welcome-message">
                            <h3>Welcome to your AI Financial Assistant</h3>
                            <p>Start a new conversation or select from suggested topics below:</p>
                            <div id="predefined-questions-inline">
                                <button class="quick-response-btn"
                                    onclick="sendPredefinedQuestion('How can I save more money?')">
                                    How can I save more money?
                                </button>
                                <button class="quick-response-btn"
                                    onclick="sendPredefinedQuestion('How can I invest my money wisely?')">
                                    How can I invest my money wisely?
                                </button>
                                <button class="quick-response-btn"
                                    onclick="sendPredefinedQuestion('How to identify a good investment opportunity?')">
                                    How to identify a good investment opportunity?
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </section>
            </main>

            <footer>
                <div id="input-area">
                    <button id="new-conversation-btn" title="New Conversation" onclick="newChat()">
                        <span class="material-symbols-outlined">
                            add_comment
                        </span>
                    </button>
                    <input type="text" id="user-input" placeholder="Ask me anything about finances..." autofocus
                        onkeypress="handleKeyPress(event)" />
                    <button id="send-btn" onclick="sendMessage()">Send</button>
                </div>
                <p>&copy; 2025 AI-Powered rights reserved.</p>
            </footer>
        </div>
    </div>

    <script>
        function deleteChatHistory() {
            if (!confirm('Are you sure you want to clear your chat history? This action cannot be undone.')) {
                return;
            }

            fetch('/delete_chat_history', {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    document.querySelector('.chat-list').innerHTML = '<div class="empty-history">No history</div>';
                    alert('Chat history cleared successfully!');
                } else {
                    alert('Failed to clear chat history. Please try again.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again later.');
            });
        }
    </script>
</body>

</html>
